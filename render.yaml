databases:
  - name: aichat-db
    databaseName: aichat
    user: aichat_user
    plan: free  # Используйте 'starter' для production

services:
  - type: web
    name: aichat
    env: node
    nodeVersion: 23.x
    rootDir: metasiberian-agent
    buildCommand: |
      curl -fsSL https://bun.sh/install | bash
      export PATH="$HOME/.bun/bin:$PATH"
      bun --version
      bun install
      # Build client using script
      if [ -f "build-client.sh" ]; then
        chmod +x build-client.sh
        ./build-client.sh
      elif [ -d "../packages/client" ]; then
        echo "Building client dependencies first..."
        if [ -d "../packages/core" ]; then
          echo "Building @elizaos/core..."
          cd ../packages/core && bun run build && cd ../../metasiberian-agent
        fi
        if [ -d "../packages/api-client" ]; then
          echo "Building @elizaos/api-client..."
          cd ../packages/api-client && bun run build && cd ../../metasiberian-agent
        fi
        echo "Building client..."
        cd ../packages/client && bun install && cd ../../metasiberian-agent
        cd ../packages/client && bunx vite build && cd ../../metasiberian-agent
        if [ -d "../packages/client/dist" ] && [ -d "node_modules/@elizaos/server" ]; then
          echo "Copying client dist to server node_modules..."
          mkdir -p node_modules/@elizaos/server/dist/client
          rm -rf node_modules/@elizaos/server/dist/client/*
          cp -r ../packages/client/dist/* node_modules/@elizaos/server/dist/client/
          if [ -f "node_modules/@elizaos/server/dist/client/index.html" ]; then
            echo "✓ Client copied to server successfully"
            if grep -q "AiChat - Client" node_modules/@elizaos/server/dist/client/index.html; then
              echo "✓ Title is correct: AiChat - Client"
            else
              echo "⚠ Warning: Title may not be correct"
              grep -i title node_modules/@elizaos/server/dist/client/index.html
            fi
          else
            echo "✗ Error: Client copy to server failed"
          fi
        else
          echo "⚠ Warning: Client dist or node_modules/@elizaos/server not found"
        fi
      fi
      bun run build
    startCommand: |
      export PATH="$HOME/.bun/bin:$PATH"
      bun run start
    healthCheckPath: /healthz
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: SERVER_PORT
        value: 3000
      - key: SERVER_HOST
        value: 0.0.0.0
      - key: OPENAI_API_KEY
        sync: false  # Установите вручную в Dashboard
      - key: POSTGRES_URL
        fromDatabase:
          name: aichat-db
          property: connectionString
      - key: SECRET_SALT
        generateValue: true  # Генерируется автоматически Render
      - key: ELIZA_SERVER_AUTH_TOKEN
        sync: false  # Установите вручную в Dashboard для безопасности

